<html>
<head>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/autofill/2.3.3/css/autoFill.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.1/css/colReorder.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/3.2.6/css/fixedColumns.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.1.5/css/fixedHeader.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.bootstrap4.min.css">



</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/autofill/2.3.3/js/dataTables.autoFill.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>



<body>
	<div id="pageheader">
		<h3>Fielding Statistics</h3>
	</div>
	<div id="loading_placeholder">Loading data...</div>
	<div id="table_content">
		<table id="fielding_datatable_table" class="table table-striped table-bordered" style="width:100%"></table>
	</div>
	<div id="input_tables" style="display:none">
		<div id="catching_stats">
			<div id="ctIncogs">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17879&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctColts">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17814&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctIslanders">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17884&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctMetchosin">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17808&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctNanaimo">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17918&grade=9302&pool=&season=2019&finals=0'></script>
			</div>			
			<div id="ctCowichan">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17877&grade=9302&pool=&season=2019&finals=0'></script>
			</div>				
			<div id="ctAlbion">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17809&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctUniversity">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17890&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="ctAlcos">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17881&grade=9302&pool=&season=2019&finals=0'></script>
			</div>		
			<div id="ctOakbay">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=18&club=23365&playerid=&mininns=&minruns=&minovers=&team=17882&grade=9302&pool=&season=2019&finals=0'></script>
			</div>	
		</div>
		<div id="runout_stats">
			<div id="roIncogs">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17879&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roColts">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17814&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roIslanders">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17884&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roMetchosin">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17808&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roNanaimo">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17918&grade=9302&pool=&season=2019&finals=0'></script>
			</div>			
			<div id="roCowichan">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17877&grade=9302&pool=&season=2019&finals=0'></script>
			</div>				
			<div id="roAlbion">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17809&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roUniversity">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17890&grade=9302&pool=&season=2019&finals=0'></script>
			</div>
			<div id="roAlcos">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17881&grade=9302&pool=&season=2019&finals=0'></script>
			</div>		
			<div id="roOakbay">
				<script src='https://www2.cricketstatz.com/ss/linkreport.aspx?mode=46&club=23365&playerid=&mininns=&minruns=&minovers=&team=17882&grade=9302&pool=&season=2019&finals=0'></script>
			</div>	
		</div>		
	</div>
</body>
	
	
 <script>
  var catching_table_headers = [];
  var catching_table_content = [];
  var runout_table_headers = [];
  var runout_table_content = [];
  var fielding_data_dict = {};
  
  // Proper sort for HS column with notouts
  jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "hs-notout-pre": function ( a ) {
        return parseFloat( a );
    },
 
    "hs-notout-asc": function ( a, b ) {
        return a - b;
    },
 
    "hs-notout-desc": function ( a, b ) {
        return b - a;
    }
  } );
  
 
  function parse_table_contents(table_id){
	var row;
	var content = [];
	var headers = [];
	$('#' + table_id + ' table').find('tr').each(function(ix_row, e_row){
		if (this.className == "ss_tablehead"){
			$(this).find('td').each(function(ix, e){
				headers.push({"title": e.textContent});
			});
		} else {
			row = []
			$(this).find('td').each(function(ix, e){
				// TODO: embed the url for the player page in Cricketstatz in the table
				if (e.lastChild && e.lastChild.href) 
					{row.push(e.innerHTML);}
				else 
					{row.push(e.textContent);}
			});
			content.push(row);
		}
	});
	return {"content": content, "headers": headers};
  }
  
  
  function respond(message) {
    window.parent.postMessage(message,"*");
  }
  
	var waitForEl = function(selector, callback) {
	  if (jQuery(selector).length) {
		callback();
	  } else {
		setTimeout(function() {
		  waitForEl(selector, callback);
		}, 100);
	  }
	};
	
	waitForEl(".ss_table", function() {
	  console.log("tables loaded");
      
      // Code to do cool things goes here
      // Pull data out of table
	  var table_values;
	  
	  // Find all the catching stats
	  var team_divs = $("#catching_stats").children().toArray();
	  // Grab data from each of those tables
	  team_divs.forEach(function(element) {
		table_values = parse_table_contents(element.id);
		if (catching_table_headers.length == 0){
			catching_table_headers = catching_table_headers.concat(table_values["headers"]);
		}
		catching_table_content = catching_table_content.concat(table_values["content"]);
	  });
	  
	  // Find all the runout stats
	  var team_divs = $("#runout_stats").children().toArray();
	  // Grab data from each of those tables
	  team_divs.forEach(function(element) {
		table_values = parse_table_contents(element.id);
		if (runout_table_headers.length == 0){
			runout_table_headers = runout_table_headers.concat(table_values["headers"]);
		}
		runout_table_content = runout_table_content.concat(table_values["content"]);
	  });	  
	  
	  // Delete Cricketstatz embedded elements
      var selector = $("#input_table .ss_table");
	  selector.remove();
      $(".ss_title").remove();
	  
	  
	  // Remove number column from data and headers
	  catching_table_headers.splice(0,1);
	  catching_table_content.forEach(function(element, index) { element.splice(0,1) });
	  runout_table_headers.splice(0,1);
	  runout_table_content.forEach(function(element, index) { element.splice(0,1) });
	  
	  // Log output of first parse
	  console.log(catching_table_content);
	  console.log(catching_table_headers);
	  console.log(runout_table_content);
	  console.log(runout_table_headers);
	  
	  // Now need to combine the two reports
	  var key_name;
	  // First runouts
	  for (ii=0; ii < runout_table_content.length; ii++){
		key_name = runout_table_content[ii][0] + "_" + runout_table_content[ii][1]
		fielding_data_dict[key_name] = {"name": runout_table_content[ii][0], "team": runout_table_content[ii][1], "matches": parseInt(runout_table_content[ii][2]), "runouts": parseInt(runout_table_content[ii][3])}
	  }
	  // Now catches
	  for (ii=0; ii < catching_table_content.length; ii++){
		key_name = catching_table_content[ii][0] + "_" + catching_table_content[ii][1]
		fielding_data_dict[key_name]["catches"] = parseInt(catching_table_content[ii][3]);
	  }
	  
	  // Add total
	  var fielding_data = Object.values(fielding_data_dict);
	  fielding_data.forEach(function(element, index) { element["total"] = element["runouts"] + element["catches"] });
	  
		var field_table = $('#fielding_datatable_table').DataTable( {
			data: fielding_data,
			columns: [
				{ "data": "name", "title": "Name" },
				{ "data": "team", "title": "Team" },
				{ "data": "matches", "title": "Matches" },
				{ "data": "catches", "title": "Catches" },
				{ "data": "runouts", "title": "Runouts" },
				{ "data": "total", "title": "Total" }
			],
			paging: true,
			scrollX: true,
			columnDefs: [{"className": "dt-center", "targets": "_all"}],
			info: false,
			lengthChange: false,
			order: [[5, "desc"]]
		} );

	  
	  // Clean up stuff
	  $("#loading_placeholder").remove();
      
	  // End code to do cool things  
	  respond("Table loaded");
	});


  
</script> 
